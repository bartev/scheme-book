// Main file for the lilypond-styles gitbook plugin
'use strict';

module.exports = {
  blocks: {
      authors: {
        // Add an "Main Author(s)" block, presumably at the top of a page
        process: function(block) {
          // This is a first shot at this block extension.
          // TODO:
             // - conditionally output (styled) content for the body
             // - add a keyword argument for "references"
             //   (e.g. to relate to a blog post or a discussion)
             //
             // TODO:
                // Currently there is a bug in gitbook that eats the
                // last arg if no keyword args are present
                // (see https://github.com/GitbookIO/gitbook/issues/804).
                // Issue has been solved and will be present in next release.
          var result = "<div id=\"authors\">\n\
            <h1>Main Author";
          (block.args.length > 1) ? result += "s" : {};
          result += ":</h1>\n<div class=\"inner-box\"\n><ul>";
          block.args.forEach(function(item) {
            result += "<li>"+item+"</li>\n";
          });
          result += "</ul>\n";
          if (block.body.length > 0) {
            result += "<div class=\"details\">"+block.body+"</div>\n"
          }
          result += "</div></div>";
          return result;
        }
      },
      credits: {
        process: function(block) {
          var result = "<div id=\"credits\">\n";
          result += "<h1>Credits</h1>\n";
          result += "<div class=\"inner-box\">";
          result += "This is a stub for a footer block giving information ";
          result += "about authors of this page, retrieved from the Git history";
          // TODO: Consider inserting a <div class="details"> here
          result += "</div></div>";
          return result;
        }
      },
      lilypond: {
        process: function(block) {
          // Call python-ly to colorize the LilyPond input
          // Return a <pre class="lilypond"> block

          var sys = require('sys')

          var spawn = require('child_process').spawnSync;

          // Call the Python script (which uses python-ly)
          var cmd = "python/colorize-lilypond";
          var run_cl = spawn(cmd, [block.body]);

          if (run_cl.stderr != null) {
            console.log(run_cl.stderr.toString())
          };
          if (run_cl.stdout != null) {
            return run_cl.stdout.toString();
          }
          else {
            return "<p><strong>LilyPond highlighting returned no result</strong></p>"
          };
        }
      }
  }
};
